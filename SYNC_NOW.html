<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¦‰ì‹œ ì£¼ë¬¸ ë™ê¸°í™”</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .status {
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      font-size: 16px;
      line-height: 1.6;
    }
    .loading {
      background: #e3f2fd;
      color: #1976d2;
      border: 2px solid #2196f3;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #4caf50;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #f44336;
    }
    .info {
      background: #fff3e0;
      color: #e65100;
      border: 2px solid #ff9800;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s;
    }
    button:hover {
      background: #4338ca;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4f46e5;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats {
      text-align: left;
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .stats p {
      margin: 5px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ ì£¼ë¬¸ ì¦‰ì‹œ ë™ê¸°í™”</h1>
    <div id="status" class="status info">
      ì¤€ë¹„ ì¤‘...
    </div>
    <div id="spinner" class="spinner" style="display: none;"></div>
    <div id="stats" class="stats" style="display: none;"></div>
    <button id="retryBtn" onclick="syncNow()" style="display: none;">ë‹¤ì‹œ ì‹œë„</button>
  </div>

  <script>
    async function syncNow() {
      const statusEl = document.getElementById('status');
      const spinnerEl = document.getElementById('spinner');
      const statsEl = document.getElementById('stats');
      const retryBtn = document.getElementById('retryBtn');
      
      try {
        // 1. localStorage í™•ì¸
        statusEl.className = 'status loading';
        statusEl.textContent = 'localStorage í™•ì¸ ì¤‘...';
        spinnerEl.style.display = 'block';
        retryBtn.style.display = 'none';
        
        const ordersJson = localStorage.getItem('hotelflow_orders_v1');
        if (!ordersJson) {
          statusEl.className = 'status error';
          statusEl.textContent = 'âŒ localStorageì— ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.\n\nHotelWorks ì•± í˜ì´ì§€ì—ì„œ ì´ íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”.';
          spinnerEl.style.display = 'none';
          return;
        }
        
        const orders = JSON.parse(ordersJson);
        const orderCount = Array.isArray(orders) ? orders.length : 0;
        
        if (orderCount === 0) {
          statusEl.className = 'status error';
          statusEl.textContent = 'âŒ ì£¼ë¬¸ì´ 0ê°œì…ë‹ˆë‹¤.\n\në¨¼ì € ì£¼ë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.';
          spinnerEl.style.display = 'none';
          return;
        }
        
        statusEl.className = 'status info';
        statusEl.textContent = `âœ… localStorageì—ì„œ ${orderCount}ê°œ ì£¼ë¬¸ ë°œê²¬!\n\në™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`;
        
        // 2. API URL ê°€ì ¸ì˜¤ê¸°
        const getApiBaseUrl = () => {
          try {
            const envUrl = (import.meta.env || {}).VITE_WS_SERVER_URL;
            if (envUrl && typeof envUrl === 'string' && envUrl.trim() !== '') {
              return envUrl.replace('ws://', 'http://').replace('wss://', 'https://');
            }
          } catch (e) {}
          
          try {
            const savedUrl = localStorage.getItem('hotelflow_ws_url');
            if (savedUrl && savedUrl.trim() !== '') {
              return savedUrl.replace('ws://', 'http://').replace('wss://', 'https://');
            }
          } catch (e) {}
          
          if (typeof window !== 'undefined' && window.location) {
            const host = window.location.hostname;
            const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
            
            if (host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.') || host.startsWith('10.')) {
              return `${protocol}//${host}:3001`;
            }
            
            // Vercelì—ì„œ ì ‘ê·¼í•˜ëŠ” ê²½ìš°
            if (host.includes('vercel.app')) {
              return 'https://hotelworks-backend.onrender.com';
            }
          }
          
          return 'http://localhost:3001';
        };
        
        // 3. ì£¼ë¬¸ í¬ë§·íŒ…
        statusEl.textContent = 'ì£¼ë¬¸ í¬ë§·íŒ… ì¤‘...';
        const formattedOrders = orders.map(order => ({
          ...order,
          requestedAt: order.requestedAt instanceof Date 
            ? order.requestedAt.toISOString() 
            : (typeof order.requestedAt === 'string' ? order.requestedAt : new Date(order.requestedAt).toISOString()),
          acceptedAt: order.acceptedAt ? (order.acceptedAt instanceof Date ? order.acceptedAt.toISOString() : order.acceptedAt) : undefined,
          inProgressAt: order.inProgressAt ? (order.inProgressAt instanceof Date ? order.inProgressAt.toISOString() : order.inProgressAt) : undefined,
          completedAt: order.completedAt ? (order.completedAt instanceof Date ? order.completedAt.toISOString() : order.completedAt) : undefined,
          memos: (order.memos || []).map(memo => ({
            ...memo,
            timestamp: memo.timestamp instanceof Date 
              ? memo.timestamp.toISOString() 
              : (typeof memo.timestamp === 'string' ? memo.timestamp : new Date(memo.timestamp).toISOString())
          }))
        }));
        
        // 4. ì„œë²„ë¡œ ì „ì†¡
        const apiUrl = `${getApiBaseUrl()}/api/orders/sync`;
        statusEl.textContent = `ì„œë²„ë¡œ ì „ì†¡ ì¤‘...\nì„œë²„: ${apiUrl}\nì£¼ë¬¸: ${formattedOrders.length}ê°œ`;
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orders: formattedOrders })
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: response.statusText }));
          throw new Error(error.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        // 5. ê²°ê³¼ í‘œì‹œ
        spinnerEl.style.display = 'none';
        statusEl.className = 'status success';
        statusEl.textContent = `âœ… ë™ê¸°í™” ì™„ë£Œ!`;
        
        statsEl.style.display = 'block';
        statsEl.innerHTML = `
          <p><strong>ì´ ì£¼ë¬¸:</strong> ${result.results.total}ê°œ</p>
          <p><strong>âœ… ìƒì„±:</strong> ${result.results.created}ê°œ</p>
          <p><strong>â­ï¸ ê±´ë„ˆëœ€:</strong> ${result.results.skipped}ê°œ</p>
          ${result.results.errors.length > 0 ? `<p><strong>âŒ ì˜¤ë¥˜:</strong> ${result.results.errors.length}ê°œ</p>` : ''}
        `;
        
        if (result.results.errors.length > 0) {
          statsEl.innerHTML += `<p style="color: red; margin-top: 10px;"><strong>ì˜¤ë¥˜ ëª©ë¡:</strong></p>`;
          result.results.errors.forEach(e => {
            statsEl.innerHTML += `<p style="color: red; font-size: 12px;">- ${e.orderId}: ${e.error}</p>`;
          });
        }
        
        if (result.results.created > 0) {
          setTimeout(() => {
            alert(`âœ… ${result.results.created}ê°œì˜ ì£¼ë¬¸ì´ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì´ì œ phpMyAdminì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
          }, 500);
        } else {
          alert(`â­ï¸ ëª¨ë“  ì£¼ë¬¸ì´ ì´ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ì— ìˆìŠµë‹ˆë‹¤.\n\n(ê±´ë„ˆëœ€: ${result.results.skipped}ê°œ)`);
        }
      } catch (error) {
        spinnerEl.style.display = 'none';
        statusEl.className = 'status error';
        statusEl.textContent = `âŒ ë™ê¸°í™” ì‹¤íŒ¨\n\n${error.message}\n\nì„œë²„ URLì„ í™•ì¸í•˜ê±°ë‚˜ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`;
        retryBtn.style.display = 'block';
        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
      }
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(syncNow, 500);
    });
  </script>
</body>
</html>
