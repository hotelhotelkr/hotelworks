<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸ ë™ê¸°í™” ë„êµ¬</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
    }
    button {
      background: #4f46e5;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #4338ca;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }
    .error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }
    .info-box {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“¦ ì£¼ë¬¸ ë™ê¸°í™” ë„êµ¬</h1>
    <div class="info">
      <strong>ì‚¬ìš© ë°©ë²•:</strong><br>
      1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì£¼ë¬¸ë“¤ì„ ë°ì´í„°ë² ì´ìŠ¤ë¡œ ë™ê¸°í™”í•©ë‹ˆë‹¤.<br>
      2. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì£¼ë¬¸ì€ ê±´ë„ˆëœë‹ˆë‹¤ (ì¤‘ë³µ ë°©ì§€).<br>
      3. ì„œë²„ URLì„ ì…ë ¥í•˜ê±°ë‚˜ ìë™ ê°ì§€í•©ë‹ˆë‹¤.
    </div>
    
    <div>
      <label>
        ì„œë²„ URL (ë¹„ì›Œë‘ë©´ ìë™ ê°ì§€):
        <input type="text" id="serverUrl" placeholder="http://localhost:3001" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
      </label>
    </div>
    
    <div style="margin-top: 20px;">
      <button onclick="checkLocalStorage()">1. localStorage í™•ì¸</button>
      <button onclick="syncOrders()">2. ë™ê¸°í™” ì‹œì‘</button>
      <button onclick="clearResult()">ê²°ê³¼ ì§€ìš°ê¸°</button>
    </div>
    
    <div id="result"></div>
  </div>

  <script>
    function getApiBaseUrl() {
      const input = document.getElementById('serverUrl').value.trim();
      if (input) {
        return input;
      }
      
      // ìë™ ê°ì§€
      const host = window.location.hostname;
      const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
      
      if (host === 'localhost' || host === '127.0.0.1' || host.startsWith('192.168.') || host.startsWith('10.')) {
        return `${protocol}//${host}:3001`;
      }
      
      // Render ë“± í”„ë¡œë•ì…˜ í™˜ê²½
      return `${protocol}//${host}:3001`;
    }
    
    function showResult(message, type = 'info') {
      const result = document.getElementById('result');
      result.textContent = message;
      result.className = type;
      result.style.display = 'block';
    }
    
    function clearResult() {
      document.getElementById('result').style.display = 'none';
    }
    
    async function checkLocalStorage() {
      try {
        const ordersJson = localStorage.getItem('hotelflow_orders_v1');
        if (!ordersJson) {
          showResult('âŒ localStorageì— ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.\ní‚¤: hotelflow_orders_v1', 'error');
          return;
        }
        
        const orders = JSON.parse(ordersJson);
        const count = Array.isArray(orders) ? orders.length : 0;
        
        if (count === 0) {
          showResult('âŒ ì£¼ë¬¸ì´ 0ê°œì…ë‹ˆë‹¤.', 'error');
          return;
        }
        
        showResult(
          `âœ… localStorageì— ${count}ê°œì˜ ì£¼ë¬¸ì´ ìˆìŠµë‹ˆë‹¤.\n\n` +
          `ì²« ë²ˆì§¸ ì£¼ë¬¸ ì˜ˆì‹œ:\n${JSON.stringify(orders[0], null, 2).substring(0, 500)}...`,
          'success'
        );
      } catch (error) {
        showResult(`âŒ localStorage í™•ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    }
    
    async function syncOrders() {
      try {
        showResult('â³ ë™ê¸°í™” ì‹œì‘...', 'info-box');
        
        const ordersJson = localStorage.getItem('hotelflow_orders_v1');
        if (!ordersJson) {
          showResult('âŒ localStorageì— ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }
        
        const orders = JSON.parse(ordersJson);
        if (!Array.isArray(orders) || orders.length === 0) {
          showResult('âŒ ì£¼ë¬¸ì´ 0ê°œì…ë‹ˆë‹¤.', 'error');
          return;
        }
        
        // Date ê°ì²´ë¥¼ ISO ë¬¸ìì—´ë¡œ ë³€í™˜
        const formattedOrders = orders.map(order => ({
          ...order,
          requestedAt: order.requestedAt instanceof Date 
            ? order.requestedAt.toISOString() 
            : (typeof order.requestedAt === 'string' ? order.requestedAt : new Date(order.requestedAt).toISOString()),
          acceptedAt: order.acceptedAt ? (order.acceptedAt instanceof Date ? order.acceptedAt.toISOString() : order.acceptedAt) : undefined,
          inProgressAt: order.inProgressAt ? (order.inProgressAt instanceof Date ? order.inProgressAt.toISOString() : order.inProgressAt) : undefined,
          completedAt: order.completedAt ? (order.completedAt instanceof Date ? order.completedAt.toISOString() : order.completedAt) : undefined,
          memos: (order.memos || []).map(memo => ({
            ...memo,
            timestamp: memo.timestamp instanceof Date 
              ? memo.timestamp.toISOString() 
              : (typeof memo.timestamp === 'string' ? memo.timestamp : new Date(memo.timestamp).toISOString())
          }))
        }));
        
        const apiUrl = `${getApiBaseUrl()}/api/orders/sync`;
        
        showResult(`â³ ì„œë²„ë¡œ ì „ì†¡ ì¤‘... (${formattedOrders.length}ê°œ ì£¼ë¬¸)\nì„œë²„: ${apiUrl}`, 'info-box');
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orders: formattedOrders })
        });
        
        if (!response.ok) {
          const error = await response.json().catch(() => ({ error: response.statusText }));
          throw new Error(error.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        showResult(
          `âœ… ë™ê¸°í™” ì™„ë£Œ!\n\n` +
          `ì´ ì£¼ë¬¸: ${result.results.total}ê°œ\n` +
          `âœ… ìƒì„±: ${result.results.created}ê°œ\n` +
          `â­ï¸ ê±´ë„ˆëœ€: ${result.results.skipped}ê°œ\n` +
          `âŒ ì˜¤ë¥˜: ${result.results.errors.length}ê°œ\n\n` +
          (result.results.errors.length > 0 
            ? `ì˜¤ë¥˜ ëª©ë¡:\n${result.results.errors.map(e => `- ${e.orderId}: ${e.error}`).join('\n')}`
            : 'ëª¨ë“  ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!'),
          'success'
        );
      } catch (error) {
        showResult(
          `âŒ ë™ê¸°í™” ì‹¤íŒ¨: ${error.message}\n\n` +
          `ì„œë²„ URLì„ í™•ì¸í•˜ê±°ë‚˜ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\n` +
          `API URL: ${getApiBaseUrl()}/api/orders/sync`,
          'error'
        );
      }
    }
  </script>
</body>
</html>
