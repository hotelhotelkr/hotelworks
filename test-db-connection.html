<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HotelWorks DB ì—°ê²° í…ŒìŠ¤íŠ¸</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .server-url {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .server-url input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: monospace;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 20px;
      border-radius: 10px;
      display: none;
    }
    .result.success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }
    .result.error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }
    .result.info {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      color: #0c5460;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 10px;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status-connected {
      background: #28a745;
      color: white;
    }
    .status-disconnected {
      background: #dc3545;
      color: white;
    }
    .config-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .config-table th,
    .config-table td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .config-table th {
      background: #f8f9fa;
      font-weight: bold;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” HotelWorks DB ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
    <p class="subtitle">ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.</p>
    
    <div class="server-url">
      <label style="display: block; margin-bottom: 8px; font-weight: bold;">ì„œë²„ URL:</label>
      <input type="text" id="serverUrl" value="https://hotelworks-backend.onrender.com" placeholder="https://hotelworks-backend.onrender.com">
    </div>
    
    <div style="margin-bottom: 20px;">
      <button onclick="testHealth()">1. ì„œë²„ ìƒíƒœ í™•ì¸</button>
      <button onclick="testDBStatus()">2. DB ì—°ê²° í™•ì¸</button>
      <button onclick="testTables()">3. í…Œì´ë¸” êµ¬ì¡° í™•ì¸</button>
      <button onclick="testAll()">ì „ì²´ í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div id="result"></div>
  </div>

  <script>
    function getServerUrl() {
      return document.getElementById('serverUrl').value.trim() || 'https://hotelworks-backend.onrender.com';
    }

    function showResult(type, title, data) {
      const resultDiv = document.getElementById('result');
      resultDiv.className = `result ${type}`;
      resultDiv.style.display = 'block';
      
      const badge = type === 'success' ? '<span class="status-badge status-connected">âœ… ì—°ê²°ë¨</span>' : 
                    type === 'error' ? '<span class="status-badge status-disconnected">âŒ ì˜¤ë¥˜</span>' : 
                    '<span class="status-badge status-connected">â„¹ï¸ ì •ë³´</span>';
      
      resultDiv.innerHTML = `
        <h2>${title} ${badge}</h2>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      `;
    }

    async function testHealth() {
      const url = getServerUrl();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<div class="loading"></div> ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...';
      resultDiv.style.display = 'block';
      resultDiv.className = 'result info';
      
      try {
        const response = await fetch(`${url}/health`);
        const data = await response.json();
        
        if (data.database && data.database.status === 'connected') {
          showResult('success', 'ì„œë²„ ë° DB ì—°ê²° ì •ìƒ', data);
        } else {
          showResult('error', 'DB ì—°ê²° ì‹¤íŒ¨', data);
          
          // í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì•ˆë‚´
          if (!data.database.config.hasConfig) {
            resultDiv.innerHTML += `
              <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                <h3>âš ï¸ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</h3>
                <p>Render Dashboardì—ì„œ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”:</p>
                <ul style="margin-top: 10px; padding-left: 20px;">
                  <li>DB_HOST</li>
                  <li>DB_PORT (ê¸°ë³¸ê°’: 3306)</li>
                  <li>DB_USER</li>
                  <li>DB_PASSWORD</li>
                  <li>DB_NAME (ê¸°ë³¸ê°’: hotelworks)</li>
                </ul>
              </div>
            `;
          }
        }
      } catch (error) {
        showResult('error', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨', { error: error.message });
      }
    }

    async function testDBStatus() {
      const url = getServerUrl();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<div class="loading"></div> DB ìƒíƒœ í™•ì¸ ì¤‘...';
      resultDiv.style.display = 'block';
      resultDiv.className = 'result info';
      
      try {
        const response = await fetch(`${url}/api/db/status`);
        const data = await response.json();
        
        if (data.status === 'connected') {
          let html = `
            <h2>âœ… DB ì—°ê²° ì„±ê³µ</h2>
            <table class="config-table">
              <tr><th>ì„¤ì • í•­ëª©</th><th>ê°’</th></th>
              <tr><td>Host</td><td>${data.config.host}</td></tr>
              <tr><td>Port</td><td>${data.config.port}</td></tr>
              <tr><td>Database</td><td>${data.config.database}</td></tr>
              <tr><td>User</td><td>${data.config.user}</td></tr>
            </table>
            <h3 style="margin-top: 20px;">í…Œì´ë¸” ìƒíƒœ:</h3>
            <ul>
              <li>ë°œê²¬ëœ í…Œì´ë¸”: ${data.tables.found.join(', ') || 'ì—†ìŒ'}</li>
              <li>ì˜ˆìƒ í…Œì´ë¸”: ${data.tables.expected.join(', ')}</li>
              <li>ëª¨ë“  í…Œì´ë¸” ì¡´ì¬: ${data.tables.allTablesExist ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}</li>
            </ul>
            <h3 style="margin-top: 20px;">ë°ì´í„°:</h3>
            <ul>
              <li>ì£¼ë¬¸ ê°œìˆ˜: ${data.orders.count}ê°œ</li>
            </ul>
            <pre style="margin-top: 15px;">${JSON.stringify(data, null, 2)}</pre>
          `;
          
          if (!data.tables.allTablesExist) {
            html += `
              <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                <h3>âš ï¸ í…Œì´ë¸”ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                <p>ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¡œì»¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:</p>
                <pre style="background: #333; color: #0f0; padding: 10px; border-radius: 5px;">npm run db:init</pre>
                <p>ë˜ëŠ” phpMyAdminì—ì„œ <code>database/schema.sql</code> íŒŒì¼ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
              </div>
            `;
          }
          
          resultDiv.innerHTML = html;
          resultDiv.className = 'result success';
        } else {
          showResult('error', 'DB ì—°ê²° ì‹¤íŒ¨', data);
        }
      } catch (error) {
        showResult('error', 'API í˜¸ì¶œ ì‹¤íŒ¨', { error: error.message });
      }
    }

    async function testTables() {
      const url = getServerUrl();
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '<div class="loading"></div> í…Œì´ë¸” êµ¬ì¡° í™•ì¸ ì¤‘...';
      resultDiv.style.display = 'block';
      resultDiv.className = 'result info';
      
      try {
        const response = await fetch(`${url}/api/db/tables`);
        const data = await response.json();
        
        if (data.success) {
          let html = '<h2>ğŸ“Š í…Œì´ë¸” êµ¬ì¡°</h2>';
          data.tables.forEach(table => {
            html += `
              <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3>ğŸ“‹ ${table.TABLE_NAME}</h3>
                <p><strong>í–‰ ê°œìˆ˜:</strong> ${table.rowCount}ê°œ</p>
                <table class="config-table" style="margin-top: 10px;">
                  <tr><th>ì»¬ëŸ¼ëª…</th><th>íƒ€ì…</th><th>NULL í—ˆìš©</th><th>ê¸°ë³¸ê°’</th></tr>
            `;
            table.columns.forEach(col => {
              html += `
                <tr>
                  <td>${col.COLUMN_NAME}</td>
                  <td>${col.DATA_TYPE}</td>
                  <td>${col.IS_NULLABLE}</td>
                  <td>${col.COLUMN_DEFAULT || '-'}</td>
                </tr>
              `;
            });
            html += '</table></div>';
          });
          
          resultDiv.innerHTML = html;
          resultDiv.className = 'result success';
        } else {
          showResult('error', 'í…Œì´ë¸” ì¡°íšŒ ì‹¤íŒ¨', data);
        }
      } catch (error) {
        showResult('error', 'API í˜¸ì¶œ ì‹¤íŒ¨', { error: error.message });
      }
    }

    async function testAll() {
      await testHealth();
      await new Promise(r => setTimeout(r, 1000));
      await testDBStatus();
      await new Promise(r => setTimeout(r, 1000));
      await testTables();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì„œë²„ ìƒíƒœ í™•ì¸
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(testHealth, 500);
    });
  </script>
</body>
</html>
