# 실시간 동기화 테스트 가이드

## ✅ 수정 완료 사항

### 1. **WebSocket 메시지 수신 로직 개선** (App.tsx)
- **로그아웃 상태**: localStorage만 업데이트 (UI는 업데이트하지 않음)
- **로그인 상태**: UI 업데이트 + 알림 표시
- **자신이 보낸 메시지**: 중복 방지를 위해 알림 스킵 (로컬에서 이미 처리됨)
- **다른 사용자의 메시지**: 실시간 UI 업데이트 + 알림 표시

### 2. **알림 시스템 개선**
- ✅ 모든 로그인된 사용자에게 알림 표시
- ✅ 자신이 보낸 메시지는 알림 스킵 (중복 방지)
- ✅ 부서별 알림 타입 구분 (FD, HK, Admin)

### 3. **서버 로깅 개선** (server.js)
- ✅ 클라이언트 연결/해제 상세 로그
- ✅ 메시지 수신/브로드캐스트 상세 로그
- ✅ 연결된 클라이언트 수 표시
- ✅ 한국 시간대로 타임스탬프 표시

### 4. **클라이언트 로깅 개선** (App.tsx)
- ✅ WebSocket 메시지 수신 시 상세 로그
- ✅ 메시지 타입별 구분된 로그
- ✅ 처리 단계별 로그 (수신 → 업데이트 → 알림)

---

## 🧪 테스트 방법

### **준비 사항**

1. **서버 시작**
```bash
npm run dev:server
# 또는
node server.js
```

2. **프론트엔드 시작** (2개 이상의 브라우저/탭)
```bash
npm run dev
```

3. **브라우저 개발자 도구 열기**
- Chrome: F12 또는 Ctrl+Shift+I
- Console 탭을 열어서 로그 확인

---

### **테스트 시나리오 1: 신규 주문 생성 실시간 동기화**

#### 목표
프론트 데스크에서 주문을 생성하면 하우스키핑에서 즉시 알림을 받고 주문 목록이 업데이트되는지 확인

#### 단계

1. **브라우저 A**: Front Desk 계정으로 로그인
   - Username: `frontdesk1`
   - Password: `password123`

2. **브라우저 B**: Housekeeping 계정으로 로그인
   - Username: `housekeeping1`
   - Password: `password123`

3. **브라우저 A (FD)**에서:
   - Dashboard로 이동
   - Rapid Order에서 방번호 선택 (예: 501호)
   - 아이템 선택 (예: 생수 2개)
   - 우선순위 설정 (Normal 또는 Urgent)
   - "HK에 요청하기" 버튼 클릭

4. **브라우저 B (HK)**에서 확인:
   - ✅ **즉시 토스트 알림이 표시되는지 확인**
     - 예: "501호 신규 요청: 생수 (수량: 2)"
   - ✅ **Orders 목록에 새 주문이 자동으로 추가되는지 확인**
   - ✅ **사운드가 재생되는지 확인**

5. **Console 로그 확인**:

**서버 콘솔**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📨 서버 메시지 수신: NEW_ORDER
   발신자: frontdesk1-id
   주문 ID: order-123
   방번호: 501
   아이템: 생수
   수량: 2
   📡 브로드캐스트 시작 - 2개 클라이언트에게 전송
   ✅ 브로드캐스트 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**브라우저 A (FD) 콘솔**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 WebSocket 메시지 수신: NEW_ORDER
   발신자: frontdesk1-id
   로그인 상태: 로그인됨 (김프론트, FRONT_DESK)
🆕 NEW_ORDER 처리 시작
   현재 사용자: 김프론트 (FRONT_DESK)
   자신의 메시지: YES
   기존 주문 발견 - 업데이트
   자신이 보낸 메시지 - 스킵
⏭️ 자신이 보낸 메시지 - 알림 스킵
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**브라우저 B (HK) 콘솔**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 WebSocket 메시지 수신: NEW_ORDER
   발신자: frontdesk1-id
   로그인 상태: 로그인됨 (박하우스, HOUSEKEEPING)
🆕 NEW_ORDER 처리 시작
   현재 사용자: 박하우스 (HOUSEKEEPING)
   자신의 메시지: NO
   새 주문 추가 - 추가 전: 5개
   새 주문 추가 - 추가 후: 6개
🔔 알림 표시 시작: 501 생수
✅ 알림 표시 완료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### **테스트 시나리오 2: 주문 상태 변경 실시간 동기화**

#### 목표
하우스키핑에서 주문 상태를 변경하면 프론트 데스크에서 즉시 알림을 받고 상태가 업데이트되는지 확인

#### 단계

1. **브라우저 B (HK)**에서:
   - Orders 페이지로 이동
   - REQUESTED 상태의 주문을 찾기
   - "접수" 버튼 클릭

2. **브라우저 A (FD)**에서 확인:
   - ✅ **즉시 토스트 알림이 표시되는지 확인**
     - 예: "501호 상태 변경: 접수됨"
   - ✅ **Orders 목록에서 주문 상태가 자동으로 변경되는지 확인**
   - ✅ **상태 배지 색상이 변경되는지 확인**
     - REQUESTED: Amber (주황색)
     - ACCEPTED: Blue (파란색)
     - IN_PROGRESS: Indigo (남색)
     - COMPLETED: Emerald (초록색)

3. **브라우저 B (HK)**에서 추가 테스트:
   - "출발" 버튼 클릭 → IN_PROGRESS로 변경
   - "완료" 버튼 클릭 → COMPLETED로 변경

4. **브라우저 A (FD)**에서:
   - 각 단계마다 실시간으로 알림과 상태가 업데이트되는지 확인

---

### **테스트 시나리오 3: 메모 추가 실시간 동기화**

#### 목표
한 사용자가 메모를 추가하면 다른 사용자도 즉시 볼 수 있는지 확인

#### 단계

1. **브라우저 A (FD)**에서:
   - Orders 페이지에서 주문 선택
   - "MEMO" 버튼 클릭
   - 메모 입력: "샴푸 2개 추가 요청"
   - "보내기" 버튼 클릭

2. **브라우저 B (HK)**에서 확인:
   - ✅ **즉시 토스트 알림이 표시되는지 확인**
     - 예: "501호 새 메모: 샴푸 2개 추가 요청"
   - ✅ **Orders 목록에서 메모가 즉시 표시되는지 확인**
   - ✅ **메모 카운트가 증가하는지 확인**

---

### **테스트 시나리오 4: 다중 기기 동시 동기화**

#### 목표
3개 이상의 클라이언트가 동시에 연결되어 있을 때 실시간 동기화 확인

#### 단계

1. **3개의 브라우저/탭 준비**:
   - 브라우저 A: Front Desk
   - 브라우저 B: Housekeeping
   - 브라우저 C: Admin

2. **브라우저 A (FD)**에서 주문 생성

3. **모든 브라우저**에서 확인:
   - ✅ 브라우저 B (HK): 알림 + 주문 목록 업데이트
   - ✅ 브라우저 C (Admin): 알림 + 주문 목록 업데이트
   - ✅ 브라우저 A (FD): 알림 없음 (자신이 보낸 메시지)

4. **서버 콘솔 확인**:
```
📡 브로드캐스트 시작 - 3개 클라이언트에게 전송
✅ 브로드캐스트 완료
```

---

### **테스트 시나리오 5: 로그아웃 상태에서 메시지 수신**

#### 목표
로그아웃 상태에서도 localStorage가 업데이트되는지 확인

#### 단계

1. **브라우저 A**: 로그인 (FD)
2. **브라우저 B**: 로그아웃 상태 (로그인 화면)

3. **브라우저 A**에서 주문 생성

4. **브라우저 B Console 확인**:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📥 WebSocket 메시지 수신: NEW_ORDER
   로그인 상태: 로그아웃됨
💾 로그아웃 상태 - localStorage만 업데이트
✅ 로그아웃 상태 - localStorage 업데이트 완료: NEW_ORDER
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

5. **브라우저 B에서 로그인**:
   - ✅ localStorage의 주문이 화면에 표시되는지 확인
   - ✅ 로그아웃 중에 생성된 주문도 보이는지 확인

---

### **테스트 시나리오 6: 네트워크 재연결 테스트**

#### 목표
네트워크 연결이 끊겼다가 복구되었을 때 동기화가 정상적으로 작동하는지 확인

#### 단계

1. **브라우저 A**: 로그인 (FD)

2. **Chrome DevTools**:
   - Network 탭 열기
   - "Offline" 모드 활성화

3. **브라우저 A**에서 주문 생성 시도:
   - 오프라인 큐에 저장되는지 Console 확인
   ```
   ⚠️ WebSocket 연결되지 않음, 오프라인 큐에 저장
   ```

4. **"Offline" 모드 비활성화**:
   - 자동 재연결 확인
   ```
   🔄 WebSocket 재연결 성공
   ✅ 오프라인 메시지 전송 (1/1)
   ✅ 오프라인 큐 동기화 완료
   ```

5. **다른 브라우저**에서:
   - ✅ 오프라인 중에 생성된 주문이 재연결 후 동기화되는지 확인

---

## 🔍 문제 해결

### 1. 알림이 표시되지 않는 경우

**확인 사항**:
- ✅ WebSocket 연결 상태 확인 (Console에서 "WebSocket 연결 성공" 메시지)
- ✅ 브라우저 알림 권한 확인
- ✅ 사운드 설정 확인 (Settings 페이지)

**Console에서 확인**:
```javascript
// WebSocket 연결 상태
console.log(socketRef.current?.connected)

// 알림 권한
console.log(Notification.permission)
```

### 2. 실시간 동기화가 안 되는 경우

**확인 사항**:
- ✅ 서버가 실행 중인지 확인 (`http://localhost:3001/health`)
- ✅ WebSocket URL이 올바른지 확인 (Settings 페이지)
- ✅ 방화벽이 3001 포트를 차단하지 않는지 확인

**서버 콘솔 확인**:
```
총 연결 수: N개  // N >= 2이어야 함
📡 브로드캐스트 시작 - N개 클라이언트에게 전송
```

### 3. 메시지가 중복되는 경우

**확인 사항**:
- ✅ Console에서 "중복 메모 무시" 또는 "자신이 보낸 메시지 - 스킵" 메시지 확인
- ✅ 같은 주문을 여러 번 생성하지 않았는지 확인

---

## 📊 예상 결과

### ✅ 성공 기준

1. **신규 주문 생성**:
   - FD → HK 알림 전달: **500ms 이내**
   - 모든 로그인된 사용자에게 실시간 동기화

2. **상태 변경**:
   - HK → FD 알림 전달: **500ms 이내**
   - 상태 배지 색상 자동 업데이트

3. **메모 추가**:
   - 모든 사용자에게 즉시 표시
   - 중복 메모 자동 필터링

4. **다중 기기**:
   - 3개 이상의 클라이언트 동시 동기화
   - 자신이 보낸 메시지는 알림 스킵

5. **오프라인 모드**:
   - 오프라인 큐에 저장
   - 재연결 시 자동 동기화

---

## 🎯 핵심 개선 사항

### Before (이전)
- ❌ 로그아웃 상태에서 UI 업데이트 시도 (불필요)
- ❌ 자신이 보낸 메시지도 알림 표시 (중복)
- ❌ 로그가 불충분하여 디버깅 어려움
- ❌ 일부 사용자만 알림 수신

### After (현재)
- ✅ 로그아웃 상태: localStorage만 업데이트 (효율적)
- ✅ 자신이 보낸 메시지: 알림 스킵 (중복 방지)
- ✅ 상세한 로그로 디버깅 용이
- ✅ 모든 로그인된 사용자에게 실시간 알림

---

## 📝 테스트 체크리스트

### 기본 테스트
- [ ] 신규 주문 생성 시 HK에 알림 전달
- [ ] 상태 변경 시 FD에 알림 전달
- [ ] 메모 추가 시 모든 사용자에게 알림
- [ ] 자신이 보낸 메시지는 알림 스킵
- [ ] 3개 이상의 클라이언트 동시 동기화

### 고급 테스트
- [ ] 로그아웃 상태에서 메시지 수신 (localStorage 업데이트)
- [ ] 네트워크 재연결 후 오프라인 큐 동기화
- [ ] 중복 메시지 필터링
- [ ] 서버 재시작 후 자동 재연결
- [ ] 모바일과 PC 간 실시간 동기화

---

## 🚀 다음 단계

테스트 완료 후:
1. ✅ 모든 테스트 시나리오 통과 확인
2. ✅ 프로덕션 환경에 배포 준비
3. ✅ 사용자 교육 자료 준비
4. ✅ 모니터링 및 로그 분석 설정

---

**작성일**: 2026-01-10  
**버전**: 1.0.0  
**작성자**: AI Assistant
